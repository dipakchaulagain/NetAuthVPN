{% extends "base.html" %}

{% block title %}Security Rules - NetAuthVPN{% endblock %}
{% block page_title %}Security Rules{% endblock %}

{% block content %}
<!-- User-Defined Rules -->
<div class="card">
    <div class="card-header bg-white">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-shield-alt"></i> Security Rules</h5>
            {% if current_user.has_role('Administrator', 'Operator') %}
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addRuleModal">
                <i class="fas fa-plus"></i> Add Rule
            </button>
            {% endif %}
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover datatable">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Route/Destination</th>
                        <th>Protocol</th>
                        <th>Port</th>
                        <th>Action</th>
                        <th>Status</th>
                        <th>Applied</th>
                        <th>Description</th>
                        {% if current_user.has_role('Administrator', 'Operator') %}
                        <th>Actions</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for rule in rules %}
                    <tr{% if not rule.enabled %} class="table-secondary" {% endif %}>
                        <td><strong>{{ rule.user.username }}</strong></td>
                        <td><code>{{ rule.route }}</code></td>
                        <td><span class="badge bg-secondary">{{ rule.protocol|upper }}</span></td>
                        <td>{{ rule.port if rule.port else 'Any' }}</td>
                        <td>
                            {% if rule.action == 'ACCEPT' %}
                            <span class="badge bg-success">ACCEPT</span>
                            {% else %}
                            <span class="badge bg-danger">DROP</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if rule.enabled %}
                            <span class="badge bg-success">Enabled</span>
                            {% else %}
                            <span class="badge bg-warning">Disabled</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if applied_users.get(rule.user.id, False) %}
                            <span class="badge bg-info"><i class="fas fa-check"></i> Applied</span>
                            {% else %}
                            <span class="badge bg-secondary">Not Applied</span>
                            {% endif %}
                        </td>
                        <td>{{ rule.description or '-' }}</td>
                        {% if current_user.has_role('Administrator', 'Operator') %}
                        <td class="text-nowrap">
                            {% if applied_users.get(rule.user.id, False) %}
                            <button type="button" class="btn btn-sm btn-secondary" disabled
                                title="Rules already applied">
                                <i class="fas fa-check"></i>
                            </button>
                            {% else %}
                            <button type="button" class="btn btn-sm btn-success" data-bs-toggle="modal"
                                data-bs-target="#applyRulesModal{{ rule.user.id }}" title="Apply rules">
                                <i class="fas fa-check"></i>
                            </button>
                            {% endif %}
                            {% if rule.enabled %}
                            <button type="button" class="btn btn-sm btn-warning" data-bs-toggle="modal"
                                data-bs-target="#toggleRuleModal{{ rule.id }}" title="Disable rule">
                                <i class="fas fa-ban"></i>
                            </button>
                            {% else %}
                            <button type="button" class="btn btn-sm btn-info" data-bs-toggle="modal"
                                data-bs-target="#toggleRuleModal{{ rule.id }}" title="Enable rule">
                                <i class="fas fa-check-circle"></i>
                            </button>
                            {% endif %}
                            <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal"
                                data-bs-target="#deleteRuleModal{{ rule.id }}" title="Delete rule">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                        {% endif %}
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="9" class="text-center text-muted">No security rules configured</td>
                        </tr>
                        {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Rule Modal -->
{% if current_user.has_role('Administrator', 'Operator') %}
<div class="modal fade" id="addRuleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Security Rule</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('security.add_rule') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Select User</label>
                        <select name="user_id" id="userSelect" class="form-select" required
                            onchange="loadUserRoutes(this.value)">
                            <option value="">-- Select a user --</option>
                            {% for user in users %}
                            <option value="{{ user.id }}">{{ user.username }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div id="routeSection" style="display: none;">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> Rules can only be created for routes assigned to this
                            user.
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Select Route/Destination</label>
                            <select name="route" id="routeSelect" class="form-select" required>
                                <option value="">-- Select a route --</option>
                            </select>
                            <small class="text-muted">Only routes assigned to the selected user are available</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Protocol</label>
                            <select name="protocol" class="form-select">
                                <option value="any">Any</option>
                                <option value="tcp">TCP</option>
                                <option value="udp">UDP</option>
                                <option value="icmp">ICMP</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Port (optional)</label>
                            <input type="text" name="port" class="form-control" placeholder="80 or 80-443">
                            <small class="text-muted">Leave empty for any port, or specify single port (80) or range
                                (80-443)</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Action</label>
                            <select name="action" class="form-select">
                                <option value="ACCEPT">ACCEPT - Allow traffic</option>
                                <option value="DROP">DROP - Block traffic</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description (optional)</label>
                            <input type="text" name="description" class="form-control" placeholder="Allow HTTPS access">
                        </div>
                    </div>

                    <div id="noRoutesWarning" style="display: none;">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i> This user has no routes assigned. Please add
                            routes first before creating security rules.
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" id="submitBtn" class="btn btn-primary" disabled>Add Rule</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}


<!-- Toggle Rule Modals (Enable/Disable) -->
{% for rule in rules %}
<div class="modal fade" id="toggleRuleModal{{ rule.id }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{% if rule.enabled %}Disable{% else %}Enable{% endif %} Security Rule</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('security.toggle_rule', rule_id=rule.id) }}">
                <div class="modal-body">
                    <p>Are you sure you want to {% if rule.enabled %}disable{% else %}enable{% endif %} this rule for
                        <strong>{{ rule.user.username }}</strong>?
                    </p>
                    <p><code>{{ rule.protocol }}:{{ rule.port or 'any' }} -> {{ rule.route }}</code></p>

                    {% if rule.enabled %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> <strong>Type "Disable" to confirm:</strong>
                    </div>
                    <input type="text" name="confirmation" class="form-control" placeholder="Type: Disable" required
                        autocomplete="off">
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-{% if rule.enabled %}warning{% else %}info{% endif %}">
                        {% if rule.enabled %}Disable{% else %}Enable{% endif %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}

<!-- Delete Rule Modals -->
{% for rule in rules %}
<div class="modal fade" id="deleteRuleModal{{ rule.id }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('security.delete_rule', rule_id=rule.id) }}">
                <div class="modal-body">
                    <p>Are you sure you want to <strong class="text-danger">permanently delete</strong> this rule for
                        <strong>{{ rule.user.username }}</strong>?
                    </p>
                    <p><code>{{ rule.protocol }}:{{ rule.port or 'any' }} -> {{ rule.route }}</code></p>

                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle"></i> <strong>Type "delete" to confirm:</strong>
                    </div>
                    <input type="text" name="confirmation" class="form-control" placeholder="Type: delete" required
                        autocomplete="off">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Delete Permanently</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}

<!-- Apply Rules Modals (per user) -->
{% for user in users %}
<div class="modal fade" id="applyRulesModal{{ user.id }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Apply Security Rules</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>This will apply all active security rules for <strong>{{ user.username }}</strong> to iptables and
                    save the configuration.</p>
                <p>The user's firewall will be updated immediately.</p>
                <p>Continue?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="POST" action="{{ url_for('security.apply_rules', user_id=user.id) }}" class="d-inline">
                    <button type="submit" class="btn btn-success">Apply Rules</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endfor %}

<script>
    function loadUserRoutes(userId) {
        const routeSection = document.getElementById('routeSection');
        const noRoutesWarning = document.getElementById('noRoutesWarning');
        const routeSelect = document.getElementById('routeSelect');
        const submitBtn = document.getElementById('submitBtn');

        if (!userId) {
            routeSection.style.display = 'none';
            noRoutesWarning.style.display = 'none';
            submitBtn.disabled = true;
            return;
        }

        // Fetch routes for the selected user from JSON API
        fetch(`/users/${userId}/routes`)
            .then(response => response.json())
            .then(data => {
                routeSelect.innerHTML = '<option value="">-- Select a route --</option>';
                let hasRoutes = false;

                if (data.routes && data.routes.length > 0) {
                    data.routes.forEach(route => {
                        const option = document.createElement('option');
                        option.value = route.route;
                        option.textContent = route.route + (route.description ? ' - ' + route.description : '');
                        routeSelect.appendChild(option);
                        hasRoutes = true;
                    });
                }

                if (hasRoutes) {
                    routeSection.style.display = 'block';
                    noRoutesWarning.style.display = 'none';
                    submitBtn.disabled = false;
                } else {
                    routeSection.style.display = 'none';
                    noRoutesWarning.style.display = 'block';
                    submitBtn.disabled = true;
                }
            })
            .catch(error => {
                console.error('Error loading routes:', error);
                routeSection.style.display = 'none';
                noRoutesWarning.style.display = 'block';
                submitBtn.disabled = true;
            });
    }
</script>
{% endblock %}